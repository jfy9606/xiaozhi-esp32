<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>ESP32 摄像头设置</title>
        <link rel='stylesheet' href='https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap'>
        <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css'>
        <style>
            body {
                font-family: 'Roboto', sans-serif;
                margin: 0;
                padding: 0;
                background-color: #f5f5f5;
                color: #333;
            }
            
            h2 {
                color: #6200ea;
                font-size: 1.5rem;
                margin: 20px 0;
            }
            
            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
                box-sizing: border-box;
            }
            
            .header {
                background: linear-gradient(145deg, #6200ea, #3700b3);
                color: white;
                padding: 15px;
                text-align: center;
                border-radius: 8px;
                margin-bottom: 20px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            }
            
            .header h1 {
                margin: 0;
                font-size: 2rem;
            }
            
            .main-content {
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
            }
            
            @media (min-width: 800px) {
                .main-content {
                    flex-direction: row;
                    align-items: flex-start;
                    justify-content: center;
                }
            }

            section.main {
                display: flex
            }

            #menu,section.main {
                flex-direction: column
            }

            #menu {
                display: none;
                flex-wrap: nowrap;
                min-width: auto;
                background: #f0f0f0;
                padding: 15px;
                border-radius: 4px;
                margin-top: 0;
                margin-right: 0;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                border: 1px solid #d0d0d0;
                overflow-x: hidden;
                box-sizing: border-box;
                width: 100%;
            }

            #content {
                display: flex;
                flex-wrap: wrap;
                align-items: stretch
            }

            figure {
                padding: 0px;
                margin: 0;
                -webkit-margin-before: 0;
                margin-block-start: 0;
                -webkit-margin-after: 0;
                margin-block-end: 0;
                -webkit-margin-start: 0;
                margin-inline-start: 0;
                -webkit-margin-end: 0;
                margin-inline-end: 0
            }

            figure img {
                display: block;
                width: 100%;
                height: auto;
                border-radius: 4px;
                margin-top: 8px;
            }

            @media (min-width: 800px) and (orientation:landscape) {
                #content {
                    display:flex;
                    flex-wrap: nowrap;
                    align-items: stretch
                }

                figure img {
                    display: block;
                    max-width: 100%;
                    max-height: calc(100vh - 40px);
                    width: auto;
                    height: auto
                }

                figure {
                    padding: 0 0 0 0px;
                    margin: 0;
                    -webkit-margin-before: 0;
                    margin-block-start: 0;
                    -webkit-margin-after: 0;
                    margin-block-end: 0;
                    -webkit-margin-start: 0;
                    margin-inline-start: 0;
                    -webkit-margin-end: 0;
                    margin-inline-end: 0
                }
            }

            section#buttons {
                display: flex;
                flex-wrap: nowrap;
                justify-content: space-between
            }

            #nav-toggle {
                cursor: pointer;
                display: block
            }

            #nav-toggle-cb {
                outline: 0;
                opacity: 0;
                width: 0;
                height: 0
            }

            #nav-toggle-cb:checked+#menu {
                display: flex
            }

            .input-group {
                margin-bottom: 15px;
                display: flex;
                align-items: center;
                flex-wrap: wrap;
                width: 100%;
                box-sizing: border-box;
            }

            .input-group > label {
                flex: 0 0 40%;
                font-weight: 500;
                margin-bottom: 5px;
                margin-right: 5px;
                color: #333;
            }

            .input-group input,
            .input-group select {
                flex: 1;
                min-width: 0;
                max-width: 100%;
                padding: 5px;
                box-sizing: border-box;
            }

            .range-max,.range-min {
                display: inline-block;
                padding: 0 5px
            }

            button, .button {
                display: block;
                margin: 5px;
                padding: 0 12px;
                border: 0;
                line-height: 28px;
                cursor: pointer;
                color: #fff;
                background: #ff3034;
                border-radius: 5px;
                font-size: 16px;
                outline: 0
            }

            .save {
                position: absolute;
                right: 25px;
                top: 0px;
                height: 16px;
                line-height: 16px;
                padding: 0 4px;
                text-decoration: none;
                cursor: pointer
            }

            button:hover {
                background: #ff494d
            }

            button:active {
                background: #f21c21
            }

            button.disabled {
                cursor: default;
                background: #a0a0a0
            }

            input[type=range] {
                -webkit-appearance: none;
                width: 100%;
                height: 22px;
                background: #f0f0f0;
                cursor: pointer;
                margin: 0
            }

            input[type=range]:focus {
                outline: 0
            }

            input[type=range]::-webkit-slider-runnable-track {
                width: 100%;
                height: 2px;
                cursor: pointer;
                background: #aaaaaa;
                border-radius: 0;
                border: 0 solid #aaaaaa;
            }

            input[type=range]::-webkit-slider-thumb {
                border: 1px solid rgba(0,0,30,0);
                height: 22px;
                width: 22px;
                border-radius: 50px;
                background: #ff3034;
                cursor: pointer;
                -webkit-appearance: none;
                margin-top: -11.5px
            }

            input[type=range]:focus::-webkit-slider-runnable-track {
                background: #EFEFEF
            }

            input[type=range]::-moz-range-track {
                width: 100%;
                height: 2px;
                cursor: pointer;
                background: #aaaaaa;
                border-radius: 0;
                border: 0 solid #aaaaaa;
            }

            input[type=range]::-moz-range-thumb {
                border: 1px solid rgba(0,0,30,0);
                height: 22px;
                width: 22px;
                border-radius: 50px;
                background: #ff3034;
                cursor: pointer
            }

            input[type=range]::-ms-track {
                width: 100%;
                height: 2px;
                cursor: pointer;
                background: 0 0;
                border-color: transparent;
                color: transparent
            }

            input[type=range]::-ms-fill-lower {
                background: #EFEFEF;
                border: 0 solid #EFEFEF;
                border-radius: 0
            }

            input[type=range]::-ms-fill-upper {
                background: #EFEFEF;
                border: 0 solid #EFEFEF;
                border-radius: 0
            }

            input[type=range]::-ms-thumb {
                border: 1px solid rgba(0,0,30,0);
                height: 22px;
                width: 22px;
                border-radius: 50px;
                background: #ff3034;
                cursor: pointer;
                height: 2px
            }

            input[type=range]:focus::-ms-fill-lower {
                background: #EFEFEF
            }

            input[type=range]:focus::-ms-fill-upper {
                background: #e0e0e0
            }

            .switch {
                display: block;
                position: relative;
                line-height: 22px;
                font-size: 16px;
                height: 22px
            }

            .switch input {
                outline: 0;
                opacity: 0;
                width: 0;
                height: 0
            }

            .slider {
                width: 50px;
                height: 22px;
                border-radius: 22px;
                cursor: pointer;
                background-color: grey
            }

            .slider,.slider:before {
                display: inline-block;
                transition: .4s
            }

            .slider:before {
                position: relative;
                content: "";
                border-radius: 50%;
                height: 16px;
                width: 16px;
                left: 4px;
                top: 3px;
                background-color: #fff
            }

            input:checked+.slider {
                background-color: #ff3034
            }

            input:checked+.slider:before {
                -webkit-transform: translateX(26px);
                transform: translateX(26px)
            }

            select {
                border: 1px solid #c0c0c0;
                font-size: 14px;
                height: 30px;
                outline: 0;
                border-radius: 5px;
                background-color: #ffffff;
                width: 100%;
                box-sizing: border-box;
            }

            .image-container {
                position: relative;
                min-width: 160px
            }

            .close {
                position: absolute;
                right: 5px;
                top: 5px;
                background: #ff3034;
                width: 16px;
                height: 16px;
                border-radius: 100px;
                color: #fff;
                text-align: center;
                line-height: 18px;
                cursor: pointer
            }

            .hidden {
                display: none
            }

            input[type=text] {
                border: 1px solid #c0c0c0;
                font-size: 14px;
                height: 20px;
                margin: 1px;
                outline: 0;
                border-radius: 5px;
                background-color: #ffffff;
            }

            .inline-button {
                line-height: 20px;
                margin: 2px 0;
                padding: 5px 8px;
                white-space: nowrap;
            }

            label.toggle-section-label {
                cursor: pointer;
                display: block
            }

            input.toggle-section-button {
                outline: 0;
                opacity: 0;
                width: 0;
                height: 0
            }

            input.toggle-section-button:checked+section.toggle-section {
                display: none
            }

            #sidebar {
                background-color: white;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                margin-bottom: 20px;
                max-width: 100%;
                width: 100%;
                box-sizing: border-box;
            }
            
            @media (min-width: 800px) {
                #sidebar {
                    flex: 0 0 340px;
                    margin-right: 20px;
                    max-height: 85vh;
                    overflow-y: auto;
                    overflow-x: hidden;
                }
            }
            
            #content {
                flex: 1;
                display: flex;
                flex-direction: column;
            }
            
            figure {
                margin: 0;
                flex: 1;
            }
            
            #stream-container {
                background-color: #222;
                border-radius: 8px;
                overflow: hidden;
                position: relative;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            }
            
            #stream {
                width: 100%;
                height: auto;
                display: block;
            }
            
            #logo {
                background-color: #6200ea;
                color: white;
                padding: 15px;
                text-align: center;
                font-weight: 500;
            }
            
            #nav-toggle {
                cursor: pointer;
                font-size: 1.1rem;
            }
            
            #menu {
                padding: 15px;
            }
            
            .input-group {
                margin-bottom: 15px;
                display: flex;
                align-items: center;
                flex-wrap: wrap;
            }
            
            .input-group > label {
                flex: 0 0 45%;
                font-weight: 500;
                margin-bottom: 5px;
            }
            
            .input-group input,
            .input-group select {
                flex: 1;
                min-width: 100px;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-family: 'Roboto', sans-serif;
            }
            
            input[type=range] {
                -webkit-appearance: none;
                height: 6px;
                background: #e0e0e0;
                border-radius: 3px;
                margin: 10px 0;
            }
            
            input[type=range]::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: #6200ea;
                cursor: pointer;
                border: none;
            }
            
            input[type=range]::-moz-range-thumb {
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: #6200ea;
                cursor: pointer;
                border: none;
            }
            
            .range-min, .range-max {
                font-size: 0.8rem;
                color: #666;
                margin: 0 5px;
            }
            
            button, .button {
                background-color: #6200ea;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 4px;
                font-size: 1rem;
                cursor: pointer;
                transition: background-color 0.3s;
                margin: 5px;
                text-decoration: none;
                display: inline-block;
                text-align: center;
            }
            
            button:hover, .button:hover {
                background-color: #3700b3;
            }
            
            /* 返回主页按钮 */
            .back-button {
                display: inline-block;
                margin: 10px 0;
                padding: 8px 15px;
                background-color: #6200ea;
                color: white;
                text-decoration: none;
                border-radius: 4px;
                font-weight: 500;
                font-size: 0.9rem;
                transition: background-color 0.3s;
                text-align: center;
            }
            .back-button:hover {
                background-color: #3700b3;
            }
            
            .save {
                position: absolute;
                top: 10px;
                right: 10px;
                background-color: rgba(98, 0, 234, 0.7);
                padding: 8px 12px;
                font-size: 0.9rem;
                border-radius: 4px;
            }
            
            .close {
                position: absolute;
                top: 10px;
                right: 10px;
                background-color: rgba(244, 67, 54, 0.7);
                color: white;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                text-align: center;
                line-height: 30px;
                font-size: 1.2rem;
                cursor: pointer;
                transition: background-color 0.3s;
            }
            
            .close:hover {
                background-color: rgba(244, 67, 54, 1);
            }
            
            #buttons {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                margin: 20px 0;
            }
            
            #buttons button {
                flex: 1;
                margin: 5px;
                min-width: 120px;
            }
            
            .switch {
                position: relative;
                display: inline-block;
                width: 50px;
                height: 24px;
            }
            
            .switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }
            
            .slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #ccc;
                transition: .4s;
                border-radius: 24px;
            }
            
            .slider:before {
                position: absolute;
                content: "";
                height: 16px;
                width: 16px;
                left: 4px;
                bottom: 4px;
                background-color: white;
                transition: .4s;
                border-radius: 50%;
            }
            
            input:checked + .slider {
                background-color: #6200ea;
            }
            
            input:checked + .slider:before {
                transform: translateX(26px);
            }
            
            .hidden {
                display: none;
            }
            
            /* 高级设置部分 */
            .section-title {
                background-color: #f0f0f0;
                padding: 10px 15px;
                margin: 15px 0 10px 0;
                border-radius: 4px;
                font-weight: 500;
                color: #6200ea;
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
                position: relative;
            }
            
            .section-title:after {
                content: '▼';
                font-size: 0.8rem;
            }
            
            .toggle-section-button:checked + .section-title:after {
                content: '▲';
            }
            
            .toggle-section-button {
                display: none;
            }
            
            .toggle-section {
                padding: 0 15px;
                overflow: hidden;
                max-height: 0;
                transition: max-height 0.3s ease-out;
                width: 100%;
                box-sizing: border-box;
            }
            
            .toggle-section-button:checked + .section-title + .toggle-section {
                max-height: 1000px;
            }
            
            hr {
                border: 0;
                height: 1px;
                background-color: #e0e0e0;
                margin: 15px 0;
            }
            
            .text {
                display: flex;
                align-items: center;
                margin-right: 5px;
                flex: 1;
            }
            
            .text input {
                flex: 1;
                min-width: 0;
                margin: 2px;
                box-sizing: border-box;
            }

            /* 添加响应式设计 - 基本媒体查询 */
            @media (max-width: 480px) {
                .header h1 {
                    font-size: 1.5rem;
                }
                
                .container {
                    padding: 10px;
                }
                
                button, .button {
                    padding: 8px 10px;
                    font-size: 14px;
                    margin: 3px;
                }
                
                .input-group > label {
                    flex: 0 0 100%;
                    margin-bottom: 5px;
                }
                
                .input-group input, 
                .input-group select,
                .switch {
                    width: 100%;
                }
                
                #buttons button {
                    flex: 0 0 100%;
                }
            }

            /* 平板设备 */
            @media (min-width: 481px) and (max-width: 768px) {
                .input-group > label {
                    flex: 0 0 40%;
                }
                
                #sidebar {
                    max-width: 100%;
                }
            }

            /* 横屏手机和小平板 */
            @media (max-width: 768px) and (orientation: landscape) {
                .main-content {
                    flex-direction: row;
                }
                
                #sidebar {
                    flex: 0 0 300px;
                    max-height: 85vh;
                    overflow-y: auto;
                }
                
                #content {
                    flex: 1;
                }
                
                .input-group {
                    margin-bottom: 10px;
                }
                
                .input-group > label {
                    flex: 0 0 40%;
                }
            }

            /* 平板和桌面 - 横屏 */
            @media (min-width: 769px) and (orientation: landscape) {
                .main-content {
                    flex-direction: row;
                }
                
                #sidebar {
                    flex: 0 0 340px;
                }
                
                #content {
                    flex: 1;
                }
                
                figure img {
                    max-height: calc(100vh - 40px);
                }
            }

            /* 竖屏平板和手机 */
            @media (max-width: 1024px) and (orientation: portrait) {
                .main-content {
                    flex-direction: column;
                }
                
                #sidebar, #content {
                    width: 100%;
                    max-width: 100%;
                }
                
                #stream-container {
                    margin-top: 20px;
                }
            }

            /* 高分辨率设备 */
            @media (min-width: 1200px) {
                .container {
                    max-width: 1400px;
                }
                
                #sidebar {
                    flex: 0 0 380px;
                }
            }

            /* 修复设置框在移动端的问题 */
            @media (max-width: 600px) {
                .toggle-section input[type="text"] {
                    max-width: 60px;
                }
                
                .text {
                    flex: 0 0 auto;
                }
                
                #set-reg-group, #get-reg-group, #set-offset-res-group, 
                #set-total-res-group, #set-output-res-group {
                    flex-wrap: wrap;
                }
                
                #menu {
                    padding: 10px;
                }
                
                .section-title {
                    padding: 8px 10px;
                    font-size: 14px;
                }
                
                .toggle-section {
                    padding: 0 10px;
                }
            }

            /* 流动布局适配 */
            #stream-container {
                position: relative;
                overflow: hidden;
                width: 100%;
                height: 0;
                padding-bottom: 75%; /* 4:3 比例 */
            }

            #stream {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                object-fit: contain;
            }

            /* 确保在所有设备上菜单都能正常显示 */
            #nav-toggle-cb:checked + #menu {
                display: flex;
                flex-direction: column;
            }

            /* 优化横竖屏切换时的平滑过渡 */
            .main-content, #sidebar, #content, #menu {
                transition: all 0.3s ease-in-out;
            }

            /* 修复iOS设备上的按钮和输入框样式 */
            button, input, select {
                -webkit-appearance: none;
                border-radius: 5px;
            }

            input[type=range] {
                -webkit-appearance: none;
            }

            /* 优化触摸设备上的交互 */
            @media (pointer: coarse) {
                button, .button, 
                .slider, 
                .section-title,
                #nav-toggle {
                    min-height: 44px; /* 符合iOS触摸指南 */
                }
                
                input, select {
                    font-size: 16px; /* 防止iOS上自动缩放 */
                }
                
                .input-group {
                    margin-bottom: 15px;
                }
            }

            /* 修复某些设备上的滚动问题 */
            body {
                -webkit-overflow-scrolling: touch;
            }
        </style>
        <script>
            // 定义全局变量
            let baseHost = '';
            let streamUrl = '';
            let viewUrl = '';
            let controlUrl = '';
            let statusUrl = '';
            let wb = null;
            
            function hide(el) {
                if(el) el.classList.add('hidden');
            }
            
            function show(el) {
                if(el) el.classList.remove('hidden');
            }
            
            function disable(el) {
                if(el) {
                    el.classList.add('disabled');
                    el.disabled = true;
                }
            }
            
            function enable(el) {
                if(el) {
                    el.classList.remove('disabled');
                    el.disabled = false;
                }
            }
            
            function fetchUrl(url, cb){
                fetch(url)
                    .then(function (response) {
                        if (response.status !== 200) {
                            cb(response.status, response.statusText);
                        } else {
                            response.text().then(function(data){
                                cb(200, data);
                            }).catch(function(err) {
                                cb(-1, err);
                            });
                        }
                    })
                    .catch(function(err) {
                        cb(-1, err);
                    });
            }
            
            function updateConfig(el, forceUpdate = false) {
                if(!el) return;
                
                let value;
                
                switch (el.type) {
                    case 'checkbox':
                        value = el.checked ? 1 : 0;
                        break;
                    case 'range':
                    case 'select-one':
                        value = el.value;
                        break;
                    case 'button':
                    case 'submit':
                        value = '1';
                        break;
                    default:
                        return;
                }
                
                // 添加防抖处理，但允许强制更新
                if (!forceUpdate && el._lastValue === value) {
                    return; // 如果值没有变化，且不是强制更新，则不发送请求
                }
                el._lastValue = value;
                
                // 对于 LED 强度控制，添加特殊处理
                if (el.id === 'led_intensity') {
                    value = parseInt(value);
                    if (value < 0) value = 0;
                    if (value > 255) value = 255;
                    console.log(`设置LED强度: ${value}`);
                }
                
                // 添加请求超时处理
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                // 修改API调用，直接使用参数名而不是var和val
                const url = `${controlUrl}?${el.id}=${value}`;
                console.log(`正在请求: ${url}`);
                
                fetch(url, {
                    signal: controller.signal
                })
                .then(response => {
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    console.log(`设置${el.id}成功: ${value}`);
                    return response.json();
                })
                .then(data => {
                    console.log("响应数据:", data);
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    console.error(`设置${el.id}失败:`, error);
                    el._lastValue = undefined; // 发生错误时重置值，允许重试
                });
            }
            
            function updateValue(el, value, updateRemote) {
                if(!el) return;
                
                updateRemote = updateRemote == null ? true : updateRemote;
                let initialValue;
                
                if (el.type === 'checkbox') {
                    initialValue = el.checked;
                    value = !!value;
                    el.checked = value;
                } else {
                    initialValue = el.value;
                    el.value = value;
                }

                if (updateRemote && initialValue !== value) {
                    updateConfig(el);
                } else if(!updateRemote){
                    if(el.id === "aec"){
                        const exposure = document.getElementById('aec_value-group');
                        if(exposure) value ? hide(exposure) : show(exposure);
                    } else if(el.id === "agc"){
                        const gainCeiling = document.getElementById('gainceiling-group');
                        const agcGain = document.getElementById('agc_gain-group');
                        if (gainCeiling && agcGain) {
                            if (value) {
                                show(gainCeiling);
                                hide(agcGain);
                            } else {
                                hide(gainCeiling);
                                show(agcGain);
                            }
                        }
                    } else if(el.id === "awb_gain"){
                        const wb = document.getElementById('wb_mode-group');
                        if(wb) value ? show(wb) : hide(wb);
                    } else if(el.id == "led_intensity"){
                        const ledGroup = document.getElementById('led-group');
                        if(ledGroup) value > -1 ? show(ledGroup) : hide(ledGroup);
                    }
                }
            }
            
            // 更新API URLs
            function updateApiUrls() {
                // 获取基础主机地址和端口
                const host = window.location.hostname;
                // 不再使用固定端口8080
                const port = window.location.port ? window.location.port : '80';
                
                // 设置基础URL（使用当前域名和端口）
                baseHost = window.location.origin;
                
                // 使用相对路径访问API，这样可以自动继承当前页面的主机和端口
                streamUrl = `/camera/stream`;
                controlUrl = `/camera/control`;
                viewUrl = `/camera/capture`;
                statusUrl = `/camera/status`;
                
                // 返回所有URL供直接使用
                return {
                    base: baseHost,
                    stream: streamUrl,
                    control: controlUrl,
                    view: viewUrl,
                    status: statusUrl
                };
            }
            
            // 获取摄像头当前状态并初始化控件
            function getCameraStatus() {
                console.log("正在获取摄像头状态...");
                
                // 添加请求超时处理
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                fetch(controlUrl, {
                    signal: controller.signal
                })
                .then(response => {
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(state => {
                    console.log("已获取摄像头状态:", JSON.stringify(state, null, 2)); // 详细打印状态对象
                    
                    // 更新所有控件值
                    document.querySelectorAll('.default-action').forEach(el => {
                        // 首先检查el和el.id是否存在
                        if (!el || typeof el.id === 'undefined') {
                            console.warn("发现一个没有ID的.default-action元素:", el);
                            return;
                        }

                        if (state.hasOwnProperty(el.id)) { // 确保状态对象中有该ID的键
                            updateValue(el, state[el.id], false);
                        } else {
                            console.warn(`状态对象中缺少键: ${el.id}，控件不会被初始化。`);
                        }
                    });
                    
                    // 特殊处理某些依赖关系
                    // 自动曝光控制
                    const aec = document.getElementById('aec');
                    const aecValueGroup = document.getElementById('aec_value-group');
                    if (aec && aecValueGroup) { // 重命名aecValue为aecValueGroup以避免与循环变量冲突
                        updateValue(aec, state.aec, false); // 确保aec本身也被正确初始化
                        state.aec ? hide(aecValueGroup) : show(aecValueGroup);
                    }
                    
                    // 自动增益控制
                    const agc = document.getElementById('agc');
                    const gainCeilingGroup = document.getElementById('gainceiling-group');
                    const agcGainGroup = document.getElementById('agc_gain-group');
                    if (agc && gainCeilingGroup && agcGainGroup) {
                        updateValue(agc, state.agc, false); // 确保agc本身也被正确初始化
                        if (state.agc) {
                            show(gainCeilingGroup);
                            hide(agcGainGroup);
                        } else {
                            hide(gainCeilingGroup);
                            show(agcGainGroup);
                        }
                    }
                    
                    // 白平衡增益
                    const awbGain = document.getElementById('awb_gain');
                    const wbModeGroup = document.getElementById('wb_mode-group');
                    if (awbGain && wbModeGroup) {
                        updateValue(awbGain, state.awb_gain, false); // 确保awb_gain本身也被正确初始化
                        state.awb_gain ? show(wbModeGroup) : hide(wbModeGroup);
                    }
                    
                    console.log("摄像头控件已更新");
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    console.error("获取摄像头状态失败:", error);
                });
            }
            
            // 等待DOM完全加载后执行初始化
            document.addEventListener('DOMContentLoaded', function () {
                console.log("DOM已加载，初始化摄像头控制界面");
                
                // 初始化API URLs
                const urls = updateApiUrls();
                baseHost = urls.base;
                streamUrl = urls.stream;
                viewUrl = urls.view;
                controlUrl = urls.control;
                statusUrl = urls.status;
                
                // 获取摄像头状态并初始化控件
                getCameraStatus();
                
                // 获取页面元素
                const view = document.getElementById('stream');
                const viewContainer = document.getElementById('stream-container');
                const stillButton = document.getElementById('get-still');
                const streamButton = document.getElementById('toggle-stream');
                const closeButton = document.getElementById('close-stream');
                const saveButton = document.getElementById('save-still');
                const ledGroup = document.getElementById('led-group');
                
                // 添加用户意图跟踪变量
                let userWantsStream = false;
                
                // 定义流控制函数
                const stopStream = () => {
                    userWantsStream = false; // 用户明确要求停止视频流
                    if(view) {
                        view.removeAttribute('src'); // 完全移除src属性
                        view.load(); // 强制浏览器停止加载
                        window.stop(); // 停止所有网络请求
                        if(streamButton) {
                            streamButton.innerHTML = '<i class="fas fa-video"></i> 开始视频流';
                            streamButton.disabled = false; // 确保按钮被启用
                        }
                    }
                    console.log('视频流已停止');
                    
                    // 通知服务器视频流已停止
                    try {
                        if (window.wsConnection && window.wsConnection.readyState === 1) {
                            window.wsConnection.send('video_stream_stopped');
                        }
                    } catch (e) {
                        console.error('无法通知服务器视频流已停止:', e);
                    }
                };

                const startStream = () => {
                    userWantsStream = true; // 用户明确要求启动视频流
                    if(view && streamUrl) {
                        // 添加错误处理
                        view.onerror = () => {
                            console.error('视频流加载失败，尝试重新连接...');
                            // 只有在用户希望视频流时才重试
                            if (userWantsStream) {
                                setTimeout(() => {
                                    if(streamButton && userWantsStream) {
                                        console.log('正在重试连接视频流...');
                                        view.src = `${streamUrl}?_cb=${Date.now()}`;
                                    }
                                }, 2000); // 增加重试间隔
                            } else {
                                stopStream(); // 确保完全停止
                            }
                        };

                        // 添加加载处理
                        view.onload = () => {
                            console.log('视频流连接成功');
                            // 通知服务器视频流已开始
                            try {
                                if (window.wsConnection && window.wsConnection.readyState === 1) {
                                    window.wsConnection.send('video_stream_started');
                                }
                            } catch (e) {
                                console.error('无法通知服务器视频流已开始:', e);
                            }
                            
                            if(streamButton) {
                                streamButton.innerHTML = '<i class="fas fa-video-slash"></i> 停止视频流';
                                streamButton.disabled = false; // 确保按钮被启用
                            }
                        };

                        // 添加加载超时处理
                        view.onloadstart = () => {
                            console.log('开始加载视频流...');
                            // 设置加载超时
                            setTimeout(() => {
                                if(view.readyState === 0 && userWantsStream) {
                                    console.error('视频流加载超时');
                                    view.onerror();
                                }
                            }, 5000);
                        };

                        // 添加播放错误处理
                        view.onstalled = () => {
                            console.error('视频流播放停滞，尝试重新连接...');
                            if (userWantsStream) {
                                view.onerror();
                            } else {
                                stopStream(); // 确保完全停止
                            }
                        };

                        // 添加播放结束处理
                        view.onended = () => {
                            console.log('视频流播放结束，尝试重新连接...');
                            if (userWantsStream) {
                                view.onerror();
                            } else {
                                stopStream(); // 确保完全停止
                            }
                        };
                        
                        // 清除之前可能的事件监听器
                        const newView = view.cloneNode(true);
                        if (view.parentNode) {
                            view.parentNode.replaceChild(newView, view);
                        }
                        const updatedView = document.getElementById('stream');
                        
                        // 设置视频源，添加时间戳防止缓存
                        console.log('正在启动视频流...');
                        // 先禁用按钮，防止重复点击
                        if(streamButton) {
                            streamButton.disabled = true;
                        }
                        
                        // 使用较低分辨率减轻负担
                        try {
                            const xhr = new XMLHttpRequest();
                            xhr.open('GET', `${controlUrl}?var=framesize&val=8`, true); // VGA分辨率(640x480)
                            xhr.send();
                        } catch (e) {
                            console.warn('设置分辨率失败，使用默认值:', e);
                        }
                        
                        // 使用更低的JPEG质量
                        try {
                            const xhr = new XMLHttpRequest();
                            xhr.open('GET', `${controlUrl}?var=quality&val=10`, true); // 10%质量
                            xhr.send();
                        } catch (e) {
                            console.warn('设置质量失败，使用默认值:', e);
                        }
                        
                        // 延迟启动视频流，给设置时间生效
                        setTimeout(() => {
                            if (userWantsStream) {
                                updatedView.src = `${streamUrl}?_cb=${Date.now()}`;
                                if(viewContainer) show(viewContainer);
                            }
                        }, 200);
                    }
                };
                
                // 新增：应用当前设置到摄像头 - 确保设置在启动视频流前生效
                const applyCurrentSettings = () => {
                    // 获取所有设置项
                    document.querySelectorAll('.default-action').forEach(el => {
                        // 向服务器发送当前值，确保设置已应用
                        if(el && el._lastValue !== undefined) {
                            updateConfig(el, true);
                        }
                    });
                    
                    // 特别处理LED闪光灯
                    const ledIntensity = document.getElementById('led_intensity');
                    if(ledIntensity) {
                        // 强制应用LED设置，无论值是否变化
                        const value = parseInt(ledIntensity.value);
                        console.log(`应用LED闪光灯设置: ${value}`);
                        fetch(`${controlUrl}?var=led_intensity&val=${value}`)
                            .then(response => {
                                if(response.ok) {
                                    console.log(`LED闪光灯强度设置成功: ${value}`);
                                } else {
                                    console.error(`LED闪光灯强度设置失败: ${response.status}`);
                                }
                            })
                            .catch(err => {
                                console.error(`LED闪光灯设置出错: ${err}`);
                            });
                    }
                };
                
                // 添加按钮事件 - 确保只绑定一次
                if (stillButton && !stillButton._hasClickHandler) {
                    stillButton._hasClickHandler = true;
                    stillButton.onclick = () => {
                        stopStream(); // 先停止当前流
                        if(viewUrl && view) {
                            view.src = `${viewUrl}?_cb=${Date.now()}`;
                            if(viewContainer) show(viewContainer);
                        }
                    };
                }

                if (closeButton && !closeButton._hasClickHandler) {
                    closeButton._hasClickHandler = true;
                    closeButton.onclick = () => {
                        stopStream();
                        if(viewContainer) hide(viewContainer);
                    };
                }

                if (streamButton && !streamButton._hasClickHandler) {
                    streamButton._hasClickHandler = true;
                    streamButton.onclick = () => {
                        const isStreamActive = streamButton.innerHTML.includes('停止视频流');
                        console.log(`当前视频流状态: ${isStreamActive ? '活动' : '停止'}`);
                        
                        if(isStreamActive) {
                            stopStream();
                        } else {
                            startStream();
                        }
                    };
                }

                if (saveButton && !saveButton._hasClickHandler) {
                    saveButton._hasClickHandler = true;
                    saveButton.onclick = () => {
                        if(!view) return;
                        
                        var canvas = document.createElement("canvas");
                        canvas.width = view.width;
                        canvas.height = view.height;
                        document.body.appendChild(canvas);
                        var context = canvas.getContext('2d');
                        context.drawImage(view, 0, 0);
                        try {
                            var dataURL = canvas.toDataURL('image/jpeg');
                            saveButton.href = dataURL;
                            var d = new Date();
                            saveButton.download = d.getFullYear() + ("0"+(d.getMonth()+1)).slice(-2) + ("0" + d.getDate()).slice(-2) + ("0" + d.getHours()).slice(-2) + ("0" + d.getMinutes()).slice(-2) + ("0" + d.getSeconds()).slice(-2) + ".jpg";
                        } catch (e) {
                            console.error(e);
                        }
                        canvas.parentNode.removeChild(canvas);
                    };
                }
                
                // 添加默认变更事件
                document.querySelectorAll('.default-action').forEach(el => {
                    if(el) el.onchange = () => updateConfig(el);
                });
                
                // 自定义操作
                // 增益
                const agc = document.getElementById('agc');
                const agcGain = document.getElementById('agc_gain-group');
                const gainCeiling = document.getElementById('gainceiling-group');
                
                if(agc) {
                    agc.onchange = () => {
                        updateConfig(agc);
                        if (agc.checked) {
                            if(gainCeiling) show(gainCeiling);
                            if(agcGain) hide(agcGain);
                        } else {
                            if(gainCeiling) hide(gainCeiling);
                            if(agcGain) show(agcGain);
                        }
                    };
                }
                
                // 曝光
                const aec = document.getElementById('aec');
                const exposure = document.getElementById('aec_value-group');
                
                if(aec) {
                    aec.onchange = () => {
                        updateConfig(aec);
                        if(exposure) {
                            aec.checked ? hide(exposure) : show(exposure);
                        }
                    };
                }
                
                // 白平衡
                const awb = document.getElementById('awb_gain');
                wb = document.getElementById('wb_mode-group');
                
                if (awb && wb) {
                    awb.onchange = () => {
                        updateConfig(awb);
                        awb.checked ? show(wb) : hide(wb);
                    };
                }
                
                // 分辨率
                const framesize = document.getElementById('framesize');
                
                if (framesize) {
                    framesize.onchange = () => updateConfig(framesize);
                }
                
                // 初始化高级设置折叠区域
                const toggleSections = document.querySelectorAll('.toggle-section-button');
                if(toggleSections.length > 0) {
                    toggleSections.forEach(toggle => {
                        if(!toggle) return;
                        
                        const section = toggle.nextElementSibling?.nextElementSibling;
                        if (section) {
                            toggle.checked = false;
                            section.style.maxHeight = "0";
                            
                            const sectionTitle = toggle.nextElementSibling;
                            if (sectionTitle) {
                                sectionTitle.addEventListener('click', function() {
                                    toggle.checked = !toggle.checked;
                                    if (toggle.checked) {
                                        section.style.maxHeight = section.scrollHeight + "px";
                                    } else {
                                        section.style.maxHeight = "0";
                                    }
                                });
                            }
                        }
                    });
                }
                
                // 将菜单设置为默认打开
                const navToggle = document.getElementById('nav-toggle-cb');
                if (navToggle) {
                    navToggle.checked = true;
                }
            });
        </script>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>ESP32 摄像头设置</h1>
            </div>
            
            <div class="main-content">
                <div id="sidebar">
                    <div id="logo">
                        <label for="nav-toggle-cb" id="nav-toggle">
                            <i class="fas fa-cog"></i> 摄像头参数设置
                        </label>
                    </div>
                    <input type="checkbox" id="nav-toggle-cb" class="hidden" checked="checked">
                    <nav id="menu">
                        <!-- XCLK设置 -->
                        <div class="input-group" id="set-xclk-group">
                            <label for="set-xclk"><i class="fas fa-clock"></i> XCLK MHz</label>
                            <div class="text">
                                <input id="xclk" type="text" minlength="1" maxlength="2" size="2" value="20">
                            </div>
                            <button class="inline-button" id="set-xclk">设置</button>
                        </div>
                        
                        <!-- 分辨率 -->
                        <div class="input-group" id="framesize-group">
                            <label for="framesize"><i class="fas fa-expand"></i> 分辨率</label>
                            <select id="framesize" class="default-action">
                                <option value="15">UXGA(1600x1200)</option>
                                <option value="14">SXGA(1280x1024)</option>
                                <option value="13">HD(1280x720)</option>
                                <option value="12">XGA(1024x768)</option>
                                <option value="11">SVGA(800x600)</option>
                                <option value="10">VGA(640x480)</option>
                                <option value="9">HVGA(480x320)</option>
                                <option value="8">CIF(400x296)</option>
                                <option value="6">QVGA(320x240)</option>
                                <option value="5">240x240</option>
                                <option value="4">HQVGA(240x176)</option>
                                <option value="3">QCIF(176x144)</option>
                                <option value="2">128x128</option>
                                <option value="1">QQVGA(160x120)</option>
                                <option value="0">96x96</option>
                            </select>
                        </div>
                        
                        <!-- 图像质量 -->
                        <div class="input-group" id="quality-group">
                            <label for="quality"><i class="fas fa-image"></i> 图像质量</label>
                            <div class="range-min">4</div>
                            <input type="range" id="quality" min="4" max="63" value="10" class="default-action">
                            <div class="range-max">63</div>
                        </div>
                        
                        <!-- 亮度 -->
                        <div class="input-group" id="brightness-group">
                            <label for="brightness"><i class="fas fa-sun"></i> 亮度</label>
                            <div class="range-min">-2</div>
                            <input type="range" id="brightness" min="-2" max="2" value="0" class="default-action">
                            <div class="range-max">2</div>
                        </div>
                        
                        <!-- 对比度 -->
                        <div class="input-group" id="contrast-group">
                            <label for="contrast"><i class="fas fa-adjust"></i> 对比度</label>
                            <div class="range-min">-2</div>
                            <input type="range" id="contrast" min="-2" max="2" value="0" class="default-action">
                            <div class="range-max">2</div>
                        </div>
                        
                        <!-- 饱和度 -->
                        <div class="input-group" id="saturation-group">
                            <label for="saturation"><i class="fas fa-palette"></i> 饱和度</label>
                            <div class="range-min">-2</div>
                            <input type="range" id="saturation" min="-2" max="2" value="0" class="default-action">
                            <div class="range-max">2</div>
                        </div>
                        
                        <!-- 特殊效果 -->
                        <div class="input-group" id="special_effect-group">
                            <label for="special_effect"><i class="fas fa-magic"></i> 特殊效果</label>
                            <select id="special_effect" class="default-action">
                                <option value="0" selected="selected">无效果</option>
                                <option value="1">负片</option>
                                <option value="2">灰度</option>
                                <option value="3">红色</option>
                                <option value="4">绿色</option>
                                <option value="5">蓝色</option>
                                <option value="6">复古</option>
                            </select>
                        </div>
                        
                        <!-- AWB -->
                        <div class="input-group" id="awb-group">
                            <label for="awb"><i class="fas fa-balance-scale"></i> 自动白平衡</label>
                            <div class="switch">
                                <input id="awb" type="checkbox" class="default-action" checked="checked">
                                <label class="slider" for="awb"></label>
                            </div>
                        </div>
                        
                        <!-- AWB 增益 -->
                        <div class="input-group" id="awb_gain-group">
                            <label for="awb_gain"><i class="fas fa-sliders-h"></i> AWB 增益</label>
                            <div class="switch">
                                <input id="awb_gain" type="checkbox" class="default-action" checked="checked">
                                <label class="slider" for="awb_gain"></label>
                            </div>
                        </div>
                        
                        <!-- WB 模式 -->
                        <div class="input-group" id="wb_mode-group">
                            <label for="wb_mode"><i class="fas fa-lightbulb"></i> 白平衡模式</label>
                            <select id="wb_mode" class="default-action">
                                <option value="0" selected="selected">自动</option>
                                <option value="1">晴天</option>
                                <option value="2">阴天</option>
                                <option value="3">办公室</option>
                                <option value="4">家庭</option>
                            </select>
                        </div>
                        
                        <!-- AEC 传感器 -->
                        <div class="input-group" id="aec-group">
                            <label for="aec"><i class="fas fa-microchip"></i> 自动曝光(传感器)</label>
                            <div class="switch">
                                <input id="aec" type="checkbox" class="default-action" checked="checked">
                                <label class="slider" for="aec"></label>
                            </div>
                        </div>
                        
                        <!-- AEC DSP -->
                        <div class="input-group" id="aec2-group">
                            <label for="aec2"><i class="fas fa-microchip"></i> 自动曝光(DSP)</label>
                            <div class="switch">
                                <input id="aec2" type="checkbox" class="default-action" checked="checked">
                                <label class="slider" for="aec2"></label>
                            </div>
                        </div>
                        
                        <!-- AE 级别 -->
                        <div class="input-group" id="ae_level-group">
                            <label for="ae_level"><i class="fas fa-layer-group"></i> AE 级别</label>
                            <div class="range-min">-2</div>
                            <input type="range" id="ae_level" min="-2" max="2" value="0" class="default-action">
                            <div class="range-max">2</div>
                        </div>
                        
                        <!-- 曝光值 -->
                        <div class="input-group" id="aec_value-group">
                            <label for="aec_value"><i class="fas fa-hourglass-half"></i> 曝光值</label>
                            <div class="range-min">0</div>
                            <input type="range" id="aec_value" min="0" max="1200" value="204" class="default-action">
                            <div class="range-max">1200</div>
                        </div>
                        
                        <!-- AGC -->
                        <div class="input-group" id="agc-group">
                            <label for="agc"><i class="fas fa-tachometer-alt"></i> 自动增益控制</label>
                            <div class="switch">
                                <input id="agc" type="checkbox" class="default-action" checked="checked">
                                <label class="slider" for="agc"></label>
                            </div>
                        </div>
                        
                        <!-- 增益 -->
                        <div class="input-group hidden" id="agc_gain-group">
                            <label for="agc_gain"><i class="fas fa-sort-amount-up"></i> 增益</label>
                            <div class="range-min">1x</div>
                            <input type="range" id="agc_gain" min="0" max="30" value="5" class="default-action">
                            <div class="range-max">31x</div>
                        </div>
                        
                        <!-- 增益上限 -->
                        <div class="input-group" id="gainceiling-group">
                            <label for="gainceiling"><i class="fas fa-arrow-up"></i> 增益上限</label>
                            <div class="range-min">2x</div>
                            <input type="range" id="gainceiling" min="0" max="6" value="0" class="default-action">
                            <div class="range-max">128x</div>
                        </div>
                        
                        <!-- BPC -->
                        <div class="input-group" id="bpc-group">
                            <label for="bpc"><i class="fas fa-eraser"></i> 坏点校正</label>
                            <div class="switch">
                                <input id="bpc" type="checkbox" class="default-action">
                                <label class="slider" for="bpc"></label>
                            </div>
                        </div>
                        
                        <!-- WPC -->
                        <div class="input-group" id="wpc-group">
                            <label for="wpc"><i class="fas fa-eraser"></i> 白点校正</label>
                            <div class="switch">
                                <input id="wpc" type="checkbox" class="default-action" checked="checked">
                                <label class="slider" for="wpc"></label>
                            </div>
                        </div>
                        
                        <!-- Raw GMA -->
                        <div class="input-group" id="raw_gma-group">
                            <label for="raw_gma"><i class="fas fa-adjust"></i> Raw GMA</label>
                            <div class="switch">
                                <input id="raw_gma" type="checkbox" class="default-action" checked="checked">
                                <label class="slider" for="raw_gma"></label>
                            </div>
                        </div>
                        
                        <!-- 镜头校正 -->
                        <div class="input-group" id="lenc-group">
                            <label for="lenc"><i class="fas fa-bullseye"></i> 镜头校正</label>
                            <div class="switch">
                                <input id="lenc" type="checkbox" class="default-action" checked="checked">
                                <label class="slider" for="lenc"></label>
                            </div>
                        </div>
                        
                        <!-- 水平镜像 -->
                        <div class="input-group" id="hmirror-group">
                            <label for="hmirror"><i class="fas fa-arrows-alt-h"></i> 水平镜像</label>
                            <div class="switch">
                                <input id="hmirror" type="checkbox" class="default-action" checked="checked">
                                <label class="slider" for="hmirror"></label>
                            </div>
                        </div>
                        
                        <!-- 垂直翻转 -->
                        <div class="input-group" id="vflip-group">
                            <label for="vflip"><i class="fas fa-arrows-alt-v"></i> 垂直翻转</label>
                            <div class="switch">
                                <input id="vflip" type="checkbox" class="default-action" checked="checked">
                                <label class="slider" for="vflip"></label>
                            </div>
                        </div>
                        
                        <!-- DCW -->
                        <div class="input-group" id="dcw-group">
                            <label for="dcw"><i class="fas fa-compress-arrows-alt"></i> 缩放功能(DCW)</label>
                            <div class="switch">
                                <input id="dcw" type="checkbox" class="default-action" checked="checked">
                                <label class="slider" for="dcw"></label>
                            </div>
                        </div>
                        
                        <!-- 色彩条 -->
                        <div class="input-group" id="colorbar-group">
                            <label for="colorbar"><i class="fas fa-table"></i> 色彩条</label>
                            <div class="switch">
                                <input id="colorbar" type="checkbox" class="default-action">
                                <label class="slider" for="colorbar"></label>
                            </div>
                        </div>
                        
                        <!-- LED亮度 -->
                        <div class="input-group" id="led-group">
                            <label for="led_intensity"><i class="fas fa-lightbulb"></i> LED亮度</label>
                            <div class="range-min">0</div>
                            <input type="range" id="led_intensity" min="0" max="255" value="0" class="default-action">
                            <div class="range-max">255</div>
                        </div>
                        
                        <!-- 按钮 -->
                        <section id="buttons">
                            <button id="get-still"><i class="fas fa-camera"></i> 拍照</button>
                            <button id="toggle-stream"><i class="fas fa-video"></i> 开始视频流</button>
                        </section>
                        
                        <!-- 高级设置 -->
                        <input type="checkbox" id="advanced-toggle" class="toggle-section-button">
                        <div class="section-title"><i class="fas fa-cogs"></i> 高级设置</div>
                        <div class="toggle-section">
                            <!-- 寄存器设置 -->
                            <input type="checkbox" id="nav-toggle-reg" class="toggle-section-button">
                            <div class="section-title"><i class="fas fa-microchip"></i> 寄存器设置</div>
                            <div class="toggle-section">
                                <div class="input-group" id="set-reg-group">
                                    <label for="set-reg">寄存器，掩码，值</label>
                                    <div class="text">
                                        <input id="reg-addr" type="text" minlength="4" maxlength="6" size="6" value="0x111">
                                    </div>
                                    <div class="text">
                                        <input id="reg-mask" type="text" minlength="4" maxlength="4" size="4" value="0x80">
                                    </div>
                                    <div class="text">
                                        <input id="reg-value" type="text" minlength="4" maxlength="4" size="4" value="0x80">
                                    </div>
                                    <button class="inline-button" id="set-reg">设置</button>
                                </div>
                                <hr>
                                <div class="input-group" id="get-reg-group">
                                    <label for="get-reg">寄存器，掩码</label>
                                    <div class="text">
                                        <input id="get-reg-addr" type="text" minlength="4" maxlength="6" size="6" value="0x111">
                                    </div>
                                    <div class="text">
                                        <input id="get-reg-mask" type="text" minlength="4" maxlength="6" size="6" value="0x80">
                                    </div>
                                    <button class="inline-button" id="get-reg">读取</button>
                                </div>
                                <div class="input-group">
                                    <label for="get-reg-value">值</label>
                                    <div class="text">
                                        <span id="get-reg-value">0x1234</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 时钟设置 -->
                            <input type="checkbox" id="nav-toggle-2640pll" class="toggle-section-button">
                            <div class="section-title"><i class="fas fa-clock"></i> 时钟设置</div>
                            <div class="toggle-section">
                                <div class="input-group">
                                    <label for="2640pll1">时钟2倍频</label>
                                    <div class="switch">
                                        <input id="2640pll1" type="checkbox" class="reg-action" reg="0x111" offset="7" mask="0x01">
                                        <label class="slider" for="2640pll1"></label>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label for="2640pll3">时钟分频</label>
                                    <div class="text">
                                        0<input id="2640pll3" type="text" minlength="1" maxlength="2" size="2" value="1" class="reg-action" reg="0x111" offset="0" mask="0x3f">63
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label for="2640pll5">自动PCLK</label>
                                    <div class="switch">
                                        <input id="2640pll5" type="checkbox" class="reg-action" reg="0xd3" offset="7" mask="0x01">
                                        <label class="slider" for="2640pll5"></label>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label for="2640pll4">PCLK分频</label>
                                    <div class="text">
                                        0<input id="2640pll4" type="text" minlength="1" maxlength="3" size="3" value="4" class="reg-action" reg="0xd3" offset="0" mask="0x7f">127
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 窗口设置 -->
                            <input type="checkbox" id="nav-toggle-win" class="toggle-section-button">
                            <div class="section-title"><i class="fas fa-crop-alt"></i> 窗口设置</div>
                            <div class="toggle-section">
                                <div class="input-group">
                                    <label for="start-x">传感器分辨率</label>
                                    <select id="start-x">
                                        <option value="2">CIF (400x296)</option>
                                        <option value="1">SVGA (800x600)</option>
                                        <option value="0" selected="selected">UXGA (1600x1200)</option>
                                    </select>
                                </div>
                                <div class="input-group" id="set-offset-res-group">
                                    <label for="offset-x">偏移</label>
                                    <div class="text">
                                        X:<input id="offset-x" type="text" minlength="1" maxlength="3" size="6" value="400">
                                    </div>
                                    <div class="text">
                                        Y:<input id="offset-y" type="text" minlength="1" maxlength="3" size="6" value="300">
                                    </div>
                                </div>
                                <div class="input-group" id="set-total-res-group">
                                    <label for="total-x">窗口大小</label>
                                    <div class="text">
                                        X:<input id="total-x" type="text" minlength="1" maxlength="4" size="6" value="800">
                                    </div>
                                    <div class="text">
                                        Y:<input id="total-y" type="text" minlength="1" maxlength="4" size="6" value="600">
                                    </div>
                                </div>
                                <div class="input-group" id="set-output-res-group">
                                    <label for="output-x">输出大小</label>
                                    <div class="text">
                                        X:<input id="output-x" type="text" minlength="1" maxlength="4" size="6" value="320">
                                    </div>
                                    <div class="text">
                                        Y:<input id="output-y" type="text" minlength="1" maxlength="4" size="6" value="240">
                                    </div>
                                </div>
                                <button id="set-resolution"><i class="fas fa-save"></i> 设置分辨率</button>
                            </div>
                        </div>
                    </nav>
                </div>
                
                <div id="content">
                    <figure>
                        <div id="stream-container" class="image-container hidden">
                            <a id="save-still" href="#" class="button save" download="capture.jpg"><i class="fas fa-download"></i> 保存</a>
                            <div class="close" id="close-stream">×</div>
                            <img id="stream" src="" crossorigin>
                        </div>
                    </figure>
                </div>
            </div>
        </div>
    </body>
</html>